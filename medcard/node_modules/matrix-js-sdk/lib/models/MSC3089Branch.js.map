{"version":3,"file":"MSC3089Branch.js","names":["MSC3089Branch","constructor","client","indexEvent","directory","id","stateKey","getStateKey","Error","isActive","getContent","version","roomId","getRoomId","delete","sendStateEvent","UNSTABLE_MSC3089_BRANCH","name","redactEvent","nextVersion","getVersionHistory","getName","setName","isLocked","setLocked","locked","getFileInfo","event","getFileEvent","file","getOriginalContent","httpUrl","mxcUrlToHttp","info","room","getRoom","getUnfilteredTimelineSet","findEventById","getLiveTimeline","getState","EventTimeline","BACKWARDS","paginationToken","scrollback","decryptEventIfNeeded","emit","isRetry","createNewVersion","encryptedContents","additionalContent","fileEventResponse","createFile","RelationType","Replace","active","fileHistory","push","timelineEvents","getEvents","reverse","childEvent","parentEvent","find","e","replacingEventId","getId","branch","getFile"],"sources":["../../src/models/MSC3089Branch.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixClient } from \"../client\";\nimport { IEncryptedFile, RelationType, UNSTABLE_MSC3089_BRANCH } from \"../@types/event\";\nimport { IContent, MatrixEvent } from \"./event\";\nimport { MSC3089TreeSpace } from \"./MSC3089TreeSpace\";\nimport { EventTimeline } from \"./event-timeline\";\nimport { FileType } from \"../http-api\";\nimport type { ISendEventResponse } from \"../@types/requests\";\n\n/**\n * Represents a [MSC3089](https://github.com/matrix-org/matrix-doc/pull/3089) branch - a reference\n * to a file (leaf) in the tree. Note that this is UNSTABLE and subject to breaking changes\n * without notice.\n */\nexport class MSC3089Branch {\n    public constructor(\n        private client: MatrixClient,\n        public readonly indexEvent: MatrixEvent,\n        public readonly directory: MSC3089TreeSpace,\n    ) {\n        // Nothing to do\n    }\n\n    /**\n     * The file ID.\n     */\n    public get id(): string {\n        const stateKey = this.indexEvent.getStateKey();\n        if (!stateKey) {\n            throw new Error(\"State key not found for branch\");\n        }\n        return stateKey;\n    }\n\n    /**\n     * Whether this branch is active/valid.\n     */\n    public get isActive(): boolean {\n        return this.indexEvent.getContent()[\"active\"] === true;\n    }\n\n    /**\n     * Version for the file, one-indexed.\n     */\n    public get version(): number {\n        return this.indexEvent.getContent()[\"version\"] ?? 1;\n    }\n\n    private get roomId(): string {\n        return this.indexEvent.getRoomId();\n    }\n\n    /**\n     * Deletes the file from the tree, including all prior edits/versions.\n     * @returns {Promise<void>} Resolves when complete.\n     */\n    public async delete(): Promise<void> {\n        await this.client.sendStateEvent(this.roomId, UNSTABLE_MSC3089_BRANCH.name, {}, this.id);\n        await this.client.redactEvent(this.roomId, this.id);\n\n        const nextVersion = (await this.getVersionHistory())[1]; // [0] will be us\n        if (nextVersion) await nextVersion.delete(); // implicit recursion\n    }\n\n    /**\n     * Gets the name for this file.\n     * @returns {string} The name, or \"Unnamed File\" if unknown.\n     */\n    public getName(): string {\n        return this.indexEvent.getContent()['name'] || \"Unnamed File\";\n    }\n\n    /**\n     * Sets the name for this file.\n     * @param {string} name The new name for this file.\n     * @returns {Promise<void>} Resolves when complete.\n     */\n    public async setName(name: string): Promise<void> {\n        await this.client.sendStateEvent(this.roomId, UNSTABLE_MSC3089_BRANCH.name, {\n            ...this.indexEvent.getContent(),\n            name: name,\n        }, this.id);\n    }\n\n    /**\n     * Gets whether or not a file is locked.\n     * @returns {boolean} True if locked, false otherwise.\n     */\n    public isLocked(): boolean {\n        return this.indexEvent.getContent()['locked'] || false;\n    }\n\n    /**\n     * Sets a file as locked or unlocked.\n     * @param {boolean} locked True to lock the file, false otherwise.\n     * @returns {Promise<void>} Resolves when complete.\n     */\n    public async setLocked(locked: boolean): Promise<void> {\n        await this.client.sendStateEvent(this.roomId, UNSTABLE_MSC3089_BRANCH.name, {\n            ...this.indexEvent.getContent(),\n            locked: locked,\n        }, this.id);\n    }\n\n    /**\n     * Gets information about the file needed to download it.\n     * @returns {Promise<{info: IEncryptedFile, httpUrl: string}>} Information about the file.\n     */\n    public async getFileInfo(): Promise<{ info: IEncryptedFile, httpUrl: string }> {\n        const event = await this.getFileEvent();\n\n        const file = event.getOriginalContent()['file'];\n        const httpUrl = this.client.mxcUrlToHttp(file['url']);\n\n        if (!httpUrl) {\n            throw new Error(`No HTTP URL available for ${file['url']}`);\n        }\n\n        return { info: file, httpUrl: httpUrl };\n    }\n\n    /**\n     * Gets the event the file points to.\n     * @returns {Promise<MatrixEvent>} Resolves to the file's event.\n     */\n    public async getFileEvent(): Promise<MatrixEvent> {\n        const room = this.client.getRoom(this.roomId);\n        if (!room) throw new Error(\"Unknown room\");\n\n        let event: MatrixEvent | undefined = room.getUnfilteredTimelineSet().findEventById(this.id);\n\n        // keep scrolling back if needed until we find the event or reach the start of the room:\n        while (!event && room.getLiveTimeline().getState(EventTimeline.BACKWARDS).paginationToken) {\n            await this.client.scrollback(room, 100);\n            event = room.getUnfilteredTimelineSet().findEventById(this.id);\n        }\n\n        if (!event) throw new Error(\"Failed to find event\");\n\n        // Sometimes the event isn't decrypted for us, so do that. We specifically set `emit: true`\n        // to ensure that the relations system in the sdk will function.\n        await this.client.decryptEventIfNeeded(event, { emit: true, isRetry: true });\n\n        return event;\n    }\n\n    /**\n     * Creates a new version of this file with contents in a type that is compatible with MatrixClient.uploadContent().\n     * @param {string} name The name of the file.\n     * @param {File | String | Buffer | ReadStream | Blob} encryptedContents The encrypted contents.\n     * @param {Partial<IEncryptedFile>} info The encrypted file information.\n     * @param {IContent} additionalContent Optional event content fields to include in the message.\n     * @returns {Promise<ISendEventResponse>} Resolves to the file event's sent response.\n     */\n    public async createNewVersion(\n        name: string,\n        encryptedContents: FileType,\n        info: Partial<IEncryptedFile>,\n        additionalContent?: IContent,\n    ): Promise<ISendEventResponse> {\n        const fileEventResponse = await this.directory.createFile(name, encryptedContents, info, {\n            ...(additionalContent ?? {}),\n            \"m.new_content\": true,\n            \"m.relates_to\": {\n                \"rel_type\": RelationType.Replace,\n                \"event_id\": this.id,\n            },\n        });\n\n        // Update the version of the new event\n        await this.client.sendStateEvent(this.roomId, UNSTABLE_MSC3089_BRANCH.name, {\n            active: true,\n            name: name,\n            version: this.version + 1,\n        }, fileEventResponse['event_id']);\n\n        // Deprecate ourselves\n        await this.client.sendStateEvent(this.roomId, UNSTABLE_MSC3089_BRANCH.name, {\n            ...(this.indexEvent.getContent()),\n            active: false,\n        }, this.id);\n\n        return fileEventResponse;\n    }\n\n    /**\n     * Gets the file's version history, starting at this file.\n     * @returns {Promise<MSC3089Branch[]>} Resolves to the file's version history, with the\n     * first element being the current version and the last element being the first version.\n     */\n    public async getVersionHistory(): Promise<MSC3089Branch[]> {\n        const fileHistory: MSC3089Branch[] = [];\n        fileHistory.push(this); // start with ourselves\n\n        const room = this.client.getRoom(this.roomId);\n        if (!room) throw new Error(\"Invalid or unknown room\");\n\n        // Clone the timeline to reverse it, getting most-recent-first ordering, hopefully\n        // shortening the awful loop below. Without the clone, we can unintentionally mutate\n        // the timeline.\n        const timelineEvents = [...room.getLiveTimeline().getEvents()].reverse();\n\n        // XXX: This is a very inefficient search, but it's the best we can do with the\n        // relations structure we have in the SDK. As of writing, it is not worth the\n        // investment in improving the structure.\n        let childEvent: MatrixEvent | undefined;\n        let parentEvent = await this.getFileEvent();\n        do {\n            childEvent = timelineEvents.find(e => e.replacingEventId() === parentEvent.getId());\n            if (childEvent) {\n                const branch = this.directory.getFile(childEvent.getId());\n                if (branch) {\n                    fileHistory.push(branch);\n                    parentEvent = childEvent;\n                } else {\n                    break; // prevent infinite loop\n                }\n            }\n        } while (childEvent);\n\n        return fileHistory;\n    }\n}\n"],"mappings":"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"}