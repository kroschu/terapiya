{"version":3,"file":"content-helpers.js","names":["makeHtmlMessage","body","htmlBody","msgtype","MsgType","Text","format","formatted_body","makeHtmlNotice","Notice","makeHtmlEmote","Emote","makeTextMessage","makeNotice","makeEmoteMessage","getTextForLocationEvent","uri","assetType","timestamp","description","date","Date","toISOString","assetName","LocationAssetType","Self","undefined","quotedDescription","filter","Boolean","join","makeLocationContent","text","defaultedText","timestampEvent","M_TIMESTAMP","name","Location","geo_uri","M_LOCATION","M_ASSET","type","TEXT_NODE_TYPE","parseLocationEvent","wireEventContent","location","findIn","asset","geoUri","fallbackText","makeTopicContent","topic","htmlTopic","renderings","mimetype","isProvided","push","M_TOPIC","parseTopicContent","content","mtopic","find","r","html","makeBeaconInfoContent","timeout","isLive","live","now","parseBeaconInfoContent","makeBeaconContent","beaconInfoEventId","rel_type","REFERENCE_RELATION","event_id","parseBeaconContent"],"sources":["../src/content-helpers.ts"],"sourcesContent":["/*\nCopyright 2018 - 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n/** @module ContentHelpers */\n\nimport { isProvided, REFERENCE_RELATION } from \"matrix-events-sdk\";\n\nimport { MBeaconEventContent, MBeaconInfoContent, MBeaconInfoEventContent } from \"./@types/beacon\";\nimport { MsgType } from \"./@types/event\";\nimport { TEXT_NODE_TYPE } from \"./@types/extensible_events\";\nimport {\n    M_ASSET,\n    LocationAssetType,\n    M_LOCATION,\n    M_TIMESTAMP,\n    LocationEventWireContent,\n    MLocationEventContent,\n    MLocationContent,\n    MAssetContent,\n    LegacyLocationEventContent,\n} from \"./@types/location\";\nimport { MRoomTopicEventContent, MTopicContent, M_TOPIC } from \"./@types/topic\";\n\n/**\n * Generates the content for a HTML Message event\n * @param {string} body the plaintext body of the message\n * @param {string} htmlBody the HTML representation of the message\n * @returns {{msgtype: string, format: string, body: string, formatted_body: string}}\n */\nexport function makeHtmlMessage(body: string, htmlBody: string) {\n    return {\n        msgtype: MsgType.Text,\n        format: \"org.matrix.custom.html\",\n        body: body,\n        formatted_body: htmlBody,\n    };\n}\n\n/**\n * Generates the content for a HTML Notice event\n * @param {string} body the plaintext body of the notice\n * @param {string} htmlBody the HTML representation of the notice\n * @returns {{msgtype: string, format: string, body: string, formatted_body: string}}\n */\nexport function makeHtmlNotice(body: string, htmlBody: string) {\n    return {\n        msgtype: MsgType.Notice,\n        format: \"org.matrix.custom.html\",\n        body: body,\n        formatted_body: htmlBody,\n    };\n}\n\n/**\n * Generates the content for a HTML Emote event\n * @param {string} body the plaintext body of the emote\n * @param {string} htmlBody the HTML representation of the emote\n * @returns {{msgtype: string, format: string, body: string, formatted_body: string}}\n */\nexport function makeHtmlEmote(body: string, htmlBody: string) {\n    return {\n        msgtype: MsgType.Emote,\n        format: \"org.matrix.custom.html\",\n        body: body,\n        formatted_body: htmlBody,\n    };\n}\n\n/**\n * Generates the content for a Plaintext Message event\n * @param {string} body the plaintext body of the emote\n * @returns {{msgtype: string, body: string}}\n */\nexport function makeTextMessage(body: string) {\n    return {\n        msgtype: MsgType.Text,\n        body: body,\n    };\n}\n\n/**\n * Generates the content for a Plaintext Notice event\n * @param {string} body the plaintext body of the notice\n * @returns {{msgtype: string, body: string}}\n */\nexport function makeNotice(body: string) {\n    return {\n        msgtype: MsgType.Notice,\n        body: body,\n    };\n}\n\n/**\n * Generates the content for a Plaintext Emote event\n * @param {string} body the plaintext body of the emote\n * @returns {{msgtype: string, body: string}}\n */\nexport function makeEmoteMessage(body: string) {\n    return {\n        msgtype: MsgType.Emote,\n        body: body,\n    };\n}\n\n/** Location content helpers */\n\nexport const getTextForLocationEvent = (\n    uri: string,\n    assetType: LocationAssetType,\n    timestamp: number,\n    description?: string,\n): string => {\n    const date = `at ${new Date(timestamp).toISOString()}`;\n    const assetName = assetType === LocationAssetType.Self ? 'User' : undefined;\n    const quotedDescription = description ? `\"${description}\"` : undefined;\n\n    return [\n        assetName,\n        'Location',\n        quotedDescription,\n        uri,\n        date,\n    ].filter(Boolean).join(' ');\n};\n\n/**\n * Generates the content for a Location event\n * @param uri a geo:// uri for the location\n * @param timestamp the timestamp when the location was correct (milliseconds since\n *           the UNIX epoch)\n * @param description the (optional) label for this location on the map\n * @param assetType the (optional) asset type of this location e.g. \"m.self\"\n * @param text optional. A text for the location\n */\nexport const makeLocationContent = (\n    // this is first but optional\n    // to avoid a breaking change\n    text: string | undefined,\n    uri: string,\n    timestamp?: number,\n    description?: string,\n    assetType?: LocationAssetType,\n): LegacyLocationEventContent & MLocationEventContent => {\n    const defaultedText = text ??\n        getTextForLocationEvent(uri, assetType || LocationAssetType.Self, timestamp, description);\n    const timestampEvent = timestamp ? { [M_TIMESTAMP.name]: timestamp } : {};\n    return {\n        msgtype: MsgType.Location,\n        body: defaultedText,\n        geo_uri: uri,\n        [M_LOCATION.name]: {\n            description,\n            uri,\n        },\n        [M_ASSET.name]: {\n            type: assetType || LocationAssetType.Self,\n        },\n        [TEXT_NODE_TYPE.name]: defaultedText,\n        ...timestampEvent,\n    } as LegacyLocationEventContent & MLocationEventContent;\n};\n\n/**\n * Parse location event content and transform to\n * a backwards compatible modern m.location event format\n */\nexport const parseLocationEvent = (wireEventContent: LocationEventWireContent): MLocationEventContent => {\n    const location = M_LOCATION.findIn<MLocationContent>(wireEventContent);\n    const asset = M_ASSET.findIn<MAssetContent>(wireEventContent);\n    const timestamp = M_TIMESTAMP.findIn<number>(wireEventContent);\n    const text = TEXT_NODE_TYPE.findIn<string>(wireEventContent);\n\n    const geoUri = location?.uri ?? wireEventContent?.geo_uri;\n    const description = location?.description;\n    const assetType = asset?.type ?? LocationAssetType.Self;\n    const fallbackText = text ?? wireEventContent.body;\n\n    return makeLocationContent(fallbackText, geoUri, timestamp, description, assetType);\n};\n\n/**\n * Topic event helpers\n */\nexport type MakeTopicContent = (\n    topic: string,\n    htmlTopic?: string,\n) => MRoomTopicEventContent;\n\nexport const makeTopicContent: MakeTopicContent = (topic, htmlTopic) => {\n    const renderings = [{ body: topic, mimetype: \"text/plain\" }];\n    if (isProvided(htmlTopic)) {\n        renderings.push({ body: htmlTopic, mimetype: \"text/html\" });\n    }\n    return { topic, [M_TOPIC.name]: renderings };\n};\n\nexport type TopicState = {\n    text: string;\n    html?: string;\n};\n\nexport const parseTopicContent = (content: MRoomTopicEventContent): TopicState => {\n    const mtopic = M_TOPIC.findIn<MTopicContent>(content);\n    const text = mtopic?.find(r => !isProvided(r.mimetype) || r.mimetype === \"text/plain\")?.body ?? content.topic;\n    const html = mtopic?.find(r => r.mimetype === \"text/html\")?.body;\n    return { text, html };\n};\n\n/**\n * Beacon event helpers\n */\nexport type MakeBeaconInfoContent = (\n    timeout: number,\n    isLive?: boolean,\n    description?: string,\n    assetType?: LocationAssetType,\n    timestamp?: number\n) => MBeaconInfoEventContent;\n\nexport const makeBeaconInfoContent: MakeBeaconInfoContent = (\n    timeout,\n    isLive,\n    description,\n    assetType,\n    timestamp,\n) => ({\n    description,\n    timeout,\n    live: isLive,\n    [M_TIMESTAMP.name]: timestamp || Date.now(),\n    [M_ASSET.name]: {\n        type: assetType ?? LocationAssetType.Self,\n    },\n});\n\nexport type BeaconInfoState = MBeaconInfoContent & {\n    assetType?: LocationAssetType;\n    timestamp: number;\n};\n/**\n * Flatten beacon info event content\n */\nexport const parseBeaconInfoContent = (content: MBeaconInfoEventContent): BeaconInfoState => {\n    const { description, timeout, live } = content;\n    const timestamp = M_TIMESTAMP.findIn<number>(content);\n    const asset = M_ASSET.findIn<MAssetContent>(content);\n\n    return {\n        description,\n        timeout,\n        live,\n        assetType: asset?.type,\n        timestamp,\n    };\n};\n\nexport type MakeBeaconContent = (\n    uri: string,\n    timestamp: number,\n    beaconInfoEventId: string,\n    description?: string,\n) => MBeaconEventContent;\n\nexport const makeBeaconContent: MakeBeaconContent = (\n    uri,\n    timestamp,\n    beaconInfoEventId,\n    description,\n) => ({\n    [M_LOCATION.name]: {\n        description,\n        uri,\n    },\n    [M_TIMESTAMP.name]: timestamp,\n    \"m.relates_to\": {\n        rel_type: REFERENCE_RELATION.name,\n        event_id: beaconInfoEventId,\n    },\n});\n\nexport type BeaconLocationState = MLocationContent & {\n    uri?: string; // override from MLocationContent to allow optionals\n    timestamp?: number;\n};\n\nexport const parseBeaconContent = (content: MBeaconEventContent): BeaconLocationState => {\n    const location = M_LOCATION.findIn<MLocationContent>(content);\n    const timestamp = M_TIMESTAMP.findIn<number>(content);\n\n    return {\n        description: location?.description,\n        uri: location?.uri,\n        timestamp,\n    };\n};\n"],"mappings":"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"}