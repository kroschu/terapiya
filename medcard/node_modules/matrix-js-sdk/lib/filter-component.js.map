{"version":3,"file":"filter-component.js","names":["matchesWildcard","actualValue","filterValue","endsWith","typePrefix","slice","length","FilterComponent","constructor","filterJson","userId","check","event","bundledRelationships","getUnsigned","relations","Object","keys","relationSenders","THREAD_RELATION_TYPE","name","current_user_participated","push","checkFields","getRoomId","getSender","getType","getContent","url","undefined","toJSON","types","not_types","rooms","not_rooms","senders","not_senders","contains_url","FILTER_RELATED_BY_SENDERS","FILTER_RELATED_BY_REL_TYPES","roomId","sender","eventType","containsUrl","relationTypes","literalKeys","v","n","matchFunc","notName","disallowedValues","some","allowedValues","containsUrlFilter","relationTypesFilter","arrayMatchesFilter","relationSendersFilter","filter","values","every","value","includes","events","limit"],"sources":["../src/filter-component.ts"],"sourcesContent":["/*\nCopyright 2016 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { RelationType } from \"./@types/event\";\nimport { MatrixEvent } from \"./models/event\";\nimport {\n    FILTER_RELATED_BY_REL_TYPES,\n    FILTER_RELATED_BY_SENDERS,\n    THREAD_RELATION_TYPE,\n} from \"./models/thread\";\n\n/**\n * @module filter-component\n */\n\n/**\n * Checks if a value matches a given field value, which may be a * terminated\n * wildcard pattern.\n * @param {String} actualValue  The value to be compared\n * @param {String} filterValue  The filter pattern to be compared\n * @return {boolean} true if the actualValue matches the filterValue\n */\nfunction matchesWildcard(actualValue: string, filterValue: string): boolean {\n    if (filterValue.endsWith(\"*\")) {\n        const typePrefix = filterValue.slice(0, -1);\n        return actualValue.slice(0, typePrefix.length) === typePrefix;\n    } else {\n        return actualValue === filterValue;\n    }\n}\n\n/* eslint-disable camelcase */\nexport interface IFilterComponent {\n    types?: string[];\n    not_types?: string[];\n    rooms?: string[];\n    not_rooms?: string[];\n    senders?: string[];\n    not_senders?: string[];\n    contains_url?: boolean;\n    limit?: number;\n    related_by_senders?: Array<RelationType | string>;\n    related_by_rel_types?: string[];\n\n    // Unstable values\n    \"io.element.relation_senders\"?: Array<RelationType | string>;\n    \"io.element.relation_types\"?: string[];\n}\n/* eslint-enable camelcase */\n\n/**\n * FilterComponent is a section of a Filter definition which defines the\n * types, rooms, senders filters etc to be applied to a particular type of resource.\n * This is all ported over from synapse's Filter object.\n *\n * N.B. that synapse refers to these as 'Filters', and what js-sdk refers to as\n * 'Filters' are referred to as 'FilterCollections'.\n *\n * @constructor\n * @param {Object} filterJson the definition of this filter JSON, e.g. { 'contains_url': true }\n */\nexport class FilterComponent {\n    constructor(private filterJson: IFilterComponent, public readonly userId?: string) {}\n\n    /**\n     * Checks with the filter component matches the given event\n     * @param {MatrixEvent} event event to be checked against the filter\n     * @return {boolean} true if the event matches the filter\n     */\n    public check(event: MatrixEvent): boolean {\n        const bundledRelationships = event.getUnsigned()?.[\"m.relations\"] || {};\n        const relations: Array<string | RelationType> = Object.keys(bundledRelationships);\n        // Relation senders allows in theory a look-up of any senders\n        // however clients can only know about the current user participation status\n        // as sending a whole list of participants could be proven problematic in terms\n        // of performance\n        // This should be improved when bundled relationships solve that problem\n        const relationSenders = [];\n        if (this.userId && bundledRelationships?.[THREAD_RELATION_TYPE.name]?.current_user_participated) {\n            relationSenders.push(this.userId);\n        }\n\n        return this.checkFields(\n            event.getRoomId(),\n            event.getSender(),\n            event.getType(),\n            event.getContent() ? event.getContent().url !== undefined : false,\n            relations,\n            relationSenders,\n        );\n    }\n\n    /**\n     * Converts the filter component into the form expected over the wire\n     */\n    public toJSON(): object {\n        return {\n            \"types\": this.filterJson.types || null,\n            \"not_types\": this.filterJson.not_types || [],\n            \"rooms\": this.filterJson.rooms || null,\n            \"not_rooms\": this.filterJson.not_rooms || [],\n            \"senders\": this.filterJson.senders || null,\n            \"not_senders\": this.filterJson.not_senders || [],\n            \"contains_url\": this.filterJson.contains_url || null,\n            [FILTER_RELATED_BY_SENDERS.name]: this.filterJson[FILTER_RELATED_BY_SENDERS.name] || [],\n            [FILTER_RELATED_BY_REL_TYPES.name]: this.filterJson[FILTER_RELATED_BY_REL_TYPES.name] || [],\n        };\n    }\n\n    /**\n     * Checks whether the filter component matches the given event fields.\n     * @param {String} roomId        the roomId for the event being checked\n     * @param {String} sender        the sender of the event being checked\n     * @param {String} eventType     the type of the event being checked\n     * @param {boolean} containsUrl  whether the event contains a content.url field\n     * @param {boolean} relationTypes  whether has aggregated relation of the given type\n     * @param {boolean} relationSenders whether one of the relation is sent by the user listed\n     * @return {boolean} true if the event fields match the filter\n     */\n    private checkFields(\n        roomId: string,\n        sender: string,\n        eventType: string,\n        containsUrl: boolean,\n        relationTypes: Array<RelationType | string>,\n        relationSenders: string[],\n    ): boolean {\n        const literalKeys = {\n            \"rooms\": function(v: string): boolean {\n                return roomId === v;\n            },\n            \"senders\": function(v: string): boolean {\n                return sender === v;\n            },\n            \"types\": function(v: string): boolean {\n                return matchesWildcard(eventType, v);\n            },\n        };\n\n        for (let n = 0; n < Object.keys(literalKeys).length; n++) {\n            const name = Object.keys(literalKeys)[n];\n            const matchFunc = literalKeys[name];\n            const notName = \"not_\" + name;\n            const disallowedValues: string[] = this.filterJson[notName];\n            if (disallowedValues?.some(matchFunc)) {\n                return false;\n            }\n\n            const allowedValues: string[] = this.filterJson[name];\n            if (allowedValues && !allowedValues.some(matchFunc)) {\n                return false;\n            }\n        }\n\n        const containsUrlFilter = this.filterJson.contains_url;\n        if (containsUrlFilter !== undefined && containsUrlFilter !== containsUrl) {\n            return false;\n        }\n\n        const relationTypesFilter = this.filterJson[FILTER_RELATED_BY_REL_TYPES.name];\n        if (relationTypesFilter !== undefined) {\n            if (!this.arrayMatchesFilter(relationTypesFilter, relationTypes)) {\n                return false;\n            }\n        }\n\n        const relationSendersFilter = this.filterJson[FILTER_RELATED_BY_SENDERS.name];\n        if (relationSendersFilter !== undefined) {\n            if (!this.arrayMatchesFilter(relationSendersFilter, relationSenders)) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n\n    private arrayMatchesFilter(filter: any[], values: any[]): boolean {\n        return values.length > 0 && filter.every(value => {\n            return values.includes(value);\n        });\n    }\n\n    /**\n     * Filters a list of events down to those which match this filter component\n     * @param {MatrixEvent[]} events  Events to be checked against the filter component\n     * @return {MatrixEvent[]} events which matched the filter component\n     */\n    public filter(events: MatrixEvent[]): MatrixEvent[] {\n        return events.filter(this.check, this);\n    }\n\n    /**\n     * Returns the limit field for a given filter component, providing a default of\n     * 10 if none is otherwise specified. Cargo-culted from Synapse.\n     * @return {Number} the limit for this filter component.\n     */\n    public limit(): number {\n        return this.filterJson.limit !== undefined ? this.filterJson.limit : 10;\n    }\n}\n"],"mappings":"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"}