{"version":3,"file":"QRCode.js","names":["SHOW_QR_CODE_METHOD","SCAN_QR_CODE_METHOD","QrCodeEvent","ReciprocateQRCode","Base","startEvent","Error","qrCodeData","request","getContent","encodedSharedSecret","newKeyMismatchError","Promise","resolve","reject","reciprocateQREvent","confirm","cancel","newUserCancelledError","emit","ShowReciprocateQr","keys","mode","Mode","VerifyOtherUser","masterKey","otherUserMasterKey","VerifySelfTrusted","deviceId","targetDevice","otherDeviceKey","VerifySelfUntrusted","myMasterKey","verifyKeys","userId","keyId","device","keyInfo","targetKey","logger","error","deviceKeyId","startsWith","deviceTargetKey","factory","channel","baseApis","NAME","CODE_VERSION","BINARY_PREFIX","QRCodeData","constructor","sharedSecret","buffer","create","client","generateSharedSecret","determineMode","otherUserCrossSigningInfo","getStoredCrossSigningForUser","otherUserId","getId","getOtherDeviceKey","myUserId","getUserId","myCrossSigningInfo","qrData","generateQrData","generateBuffer","getBuffer","secretBytes","Uint8Array","global","crypto","getRandomValues","encodeUnpaddedBase64","otherDevice","otherDeviceId","getStoredDevice","getFingerprint","myTrust","checkUserTrust","isCrossSigningVerified","transactionId","prefix","version","firstKeyB64","secondKeyB64","secretB64","getDeviceEd25519Key","buf","Buffer","alloc","appendByte","b","tmpBuf","from","concat","appendInt","i","writeInt16BE","appendStr","s","enc","withLengthPrefix","byteLength","appendEncBase64","b64","decodeBase64"],"sources":["../../../src/crypto/verification/QRCode.ts"],"sourcesContent":["/*\nCopyright 2018 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n/**\n * QR code key verification.\n * @module crypto/verification/QRCode\n */\n\nimport { VerificationBase as Base, VerificationEventHandlerMap } from \"./Base\";\nimport { newKeyMismatchError, newUserCancelledError } from './Error';\nimport { decodeBase64, encodeUnpaddedBase64 } from \"../olmlib\";\nimport { logger } from '../../logger';\nimport { VerificationRequest } from \"./request/VerificationRequest\";\nimport { MatrixClient } from \"../../client\";\nimport { IVerificationChannel } from \"./request/Channel\";\nimport { MatrixEvent } from \"../../models/event\";\n\nexport const SHOW_QR_CODE_METHOD = \"m.qr_code.show.v1\";\nexport const SCAN_QR_CODE_METHOD = \"m.qr_code.scan.v1\";\n\ninterface IReciprocateQr {\n    confirm(): void;\n    cancel(): void;\n}\n\nexport enum QrCodeEvent {\n    ShowReciprocateQr = \"show_reciprocate_qr\",\n}\n\ntype EventHandlerMap = {\n    [QrCodeEvent.ShowReciprocateQr]: (qr: IReciprocateQr) => void;\n} & VerificationEventHandlerMap;\n\n/**\n * @class crypto/verification/QRCode/ReciprocateQRCode\n * @extends {module:crypto/verification/Base}\n */\nexport class ReciprocateQRCode extends Base<QrCodeEvent, EventHandlerMap> {\n    public reciprocateQREvent: IReciprocateQr;\n\n    public static factory(\n        channel: IVerificationChannel,\n        baseApis: MatrixClient,\n        userId: string,\n        deviceId: string,\n        startEvent: MatrixEvent,\n        request: VerificationRequest,\n    ): ReciprocateQRCode {\n        return new ReciprocateQRCode(channel, baseApis, userId, deviceId, startEvent, request);\n    }\n\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    public static get NAME(): string {\n        return \"m.reciprocate.v1\";\n    }\n\n    protected doVerification = async (): Promise<void> => {\n        if (!this.startEvent) {\n            // TODO: Support scanning QR codes\n            throw new Error(\"It is not currently possible to start verification\" +\n                \"with this method yet.\");\n        }\n\n        const { qrCodeData } = this.request;\n        // 1. check the secret\n        if (this.startEvent.getContent()['secret'] !== qrCodeData.encodedSharedSecret) {\n            throw newKeyMismatchError();\n        }\n\n        // 2. ask if other user shows shield as well\n        await new Promise<void>((resolve, reject) => {\n            this.reciprocateQREvent = {\n                confirm: resolve,\n                cancel: () => reject(newUserCancelledError()),\n            };\n            this.emit(QrCodeEvent.ShowReciprocateQr, this.reciprocateQREvent);\n        });\n\n        // 3. determine key to sign / mark as trusted\n        const keys: Record<string, string> = {};\n\n        switch (qrCodeData.mode) {\n            case Mode.VerifyOtherUser: {\n                // add master key to keys to be signed, only if we're not doing self-verification\n                const masterKey = qrCodeData.otherUserMasterKey;\n                keys[`ed25519:${masterKey}`] = masterKey;\n                break;\n            }\n            case Mode.VerifySelfTrusted: {\n                const deviceId = this.request.targetDevice.deviceId;\n                keys[`ed25519:${deviceId}`] = qrCodeData.otherDeviceKey;\n                break;\n            }\n            case Mode.VerifySelfUntrusted: {\n                const masterKey = qrCodeData.myMasterKey;\n                keys[`ed25519:${masterKey}`] = masterKey;\n                break;\n            }\n        }\n\n        // 4. sign the key (or mark own MSK as verified in case of MODE_VERIFY_SELF_TRUSTED)\n        await this.verifyKeys(this.userId, keys, (keyId, device, keyInfo) => {\n            // make sure the device has the expected keys\n            const targetKey = keys[keyId];\n            if (!targetKey) throw newKeyMismatchError();\n\n            if (keyInfo !== targetKey) {\n                logger.error(\"key ID from key info does not match\");\n                throw newKeyMismatchError();\n            }\n            for (const deviceKeyId in device.keys) {\n                if (!deviceKeyId.startsWith(\"ed25519\")) continue;\n                const deviceTargetKey = keys[deviceKeyId];\n                if (!deviceTargetKey) throw newKeyMismatchError();\n                if (device.keys[deviceKeyId] !== deviceTargetKey) {\n                    logger.error(\"master key does not match\");\n                    throw newKeyMismatchError();\n                }\n            }\n        });\n    };\n}\n\nconst CODE_VERSION = 0x02; // the version of binary QR codes we support\nconst BINARY_PREFIX = \"MATRIX\"; // ASCII, used to prefix the binary format\n\nenum Mode {\n    VerifyOtherUser = 0x00, // Verifying someone who isn't us\n    VerifySelfTrusted = 0x01, // We trust the master key\n    VerifySelfUntrusted = 0x02, // We do not trust the master key\n}\n\ninterface IQrData {\n    prefix: string;\n    version: number;\n    mode: Mode;\n    transactionId: string;\n    firstKeyB64: string;\n    secondKeyB64: string;\n    secretB64: string;\n}\n\nexport class QRCodeData {\n    constructor(\n        public readonly mode: Mode,\n        private readonly sharedSecret: string,\n        // only set when mode is MODE_VERIFY_OTHER_USER, master key of other party at time of generating QR code\n        public readonly otherUserMasterKey: string | undefined,\n        // only set when mode is MODE_VERIFY_SELF_TRUSTED, device key of other party at time of generating QR code\n        public readonly otherDeviceKey: string | undefined,\n        // only set when mode is MODE_VERIFY_SELF_UNTRUSTED, own master key at time of generating QR code\n        public readonly myMasterKey: string | undefined,\n        private readonly buffer: Buffer,\n    ) {}\n\n    public static async create(request: VerificationRequest, client: MatrixClient): Promise<QRCodeData> {\n        const sharedSecret = QRCodeData.generateSharedSecret();\n        const mode = QRCodeData.determineMode(request, client);\n        let otherUserMasterKey = null;\n        let otherDeviceKey = null;\n        let myMasterKey = null;\n        if (mode === Mode.VerifyOtherUser) {\n            const otherUserCrossSigningInfo =\n                client.getStoredCrossSigningForUser(request.otherUserId);\n            otherUserMasterKey = otherUserCrossSigningInfo.getId(\"master\");\n        } else if (mode === Mode.VerifySelfTrusted) {\n            otherDeviceKey = await QRCodeData.getOtherDeviceKey(request, client);\n        } else if (mode === Mode.VerifySelfUntrusted) {\n            const myUserId = client.getUserId();\n            const myCrossSigningInfo = client.getStoredCrossSigningForUser(myUserId);\n            myMasterKey = myCrossSigningInfo.getId(\"master\");\n        }\n        const qrData = QRCodeData.generateQrData(\n            request, client, mode,\n            sharedSecret,\n            otherUserMasterKey,\n            otherDeviceKey,\n            myMasterKey,\n        );\n        const buffer = QRCodeData.generateBuffer(qrData);\n        return new QRCodeData(mode, sharedSecret,\n            otherUserMasterKey, otherDeviceKey, myMasterKey, buffer);\n    }\n\n    /**\n     * The unpadded base64 encoded shared secret.\n     */\n    public get encodedSharedSecret(): string {\n        return this.sharedSecret;\n    }\n\n    public getBuffer(): Buffer {\n        return this.buffer;\n    }\n\n    private static generateSharedSecret(): string {\n        const secretBytes = new Uint8Array(11);\n        global.crypto.getRandomValues(secretBytes);\n        return encodeUnpaddedBase64(secretBytes);\n    }\n\n    private static async getOtherDeviceKey(request: VerificationRequest, client: MatrixClient): Promise<string> {\n        const myUserId = client.getUserId();\n        const otherDevice = request.targetDevice;\n        const otherDeviceId = otherDevice ? otherDevice.deviceId : null;\n        const device = client.getStoredDevice(myUserId, otherDeviceId);\n        if (!device) {\n            throw new Error(\"could not find device \" + otherDeviceId);\n        }\n        return device.getFingerprint();\n    }\n\n    private static determineMode(request: VerificationRequest, client: MatrixClient): Mode {\n        const myUserId = client.getUserId();\n        const otherUserId = request.otherUserId;\n\n        let mode = Mode.VerifyOtherUser;\n        if (myUserId === otherUserId) {\n            // Mode changes depending on whether or not we trust the master cross signing key\n            const myTrust = client.checkUserTrust(myUserId);\n            if (myTrust.isCrossSigningVerified()) {\n                mode = Mode.VerifySelfTrusted;\n            } else {\n                mode = Mode.VerifySelfUntrusted;\n            }\n        }\n        return mode;\n    }\n\n    private static generateQrData(\n        request: VerificationRequest,\n        client: MatrixClient,\n        mode: Mode,\n        encodedSharedSecret: string,\n        otherUserMasterKey: string,\n        otherDeviceKey: string,\n        myMasterKey: string,\n    ): IQrData {\n        const myUserId = client.getUserId();\n        const transactionId = request.channel.transactionId;\n        const qrData = {\n            prefix: BINARY_PREFIX,\n            version: CODE_VERSION,\n            mode,\n            transactionId,\n            firstKeyB64: '', // worked out shortly\n            secondKeyB64: '', // worked out shortly\n            secretB64: encodedSharedSecret,\n        };\n\n        const myCrossSigningInfo = client.getStoredCrossSigningForUser(myUserId);\n\n        if (mode === Mode.VerifyOtherUser) {\n            // First key is our master cross signing key\n            qrData.firstKeyB64 = myCrossSigningInfo.getId(\"master\");\n            // Second key is the other user's master cross signing key\n            qrData.secondKeyB64 = otherUserMasterKey;\n        } else if (mode === Mode.VerifySelfTrusted) {\n            // First key is our master cross signing key\n            qrData.firstKeyB64 = myCrossSigningInfo.getId(\"master\");\n            qrData.secondKeyB64 = otherDeviceKey;\n        } else if (mode === Mode.VerifySelfUntrusted) {\n            // First key is our device's key\n            qrData.firstKeyB64 = client.getDeviceEd25519Key();\n            // Second key is what we think our master cross signing key is\n            qrData.secondKeyB64 = myMasterKey;\n        }\n        return qrData;\n    }\n\n    private static generateBuffer(qrData: IQrData): Buffer {\n        let buf = Buffer.alloc(0); // we'll concat our way through life\n\n        const appendByte = (b) => {\n            const tmpBuf = Buffer.from([b]);\n            buf = Buffer.concat([buf, tmpBuf]);\n        };\n        const appendInt = (i) => {\n            const tmpBuf = Buffer.alloc(2);\n            tmpBuf.writeInt16BE(i, 0);\n            buf = Buffer.concat([buf, tmpBuf]);\n        };\n        const appendStr = (s, enc, withLengthPrefix = true) => {\n            const tmpBuf = Buffer.from(s, enc);\n            if (withLengthPrefix) appendInt(tmpBuf.byteLength);\n            buf = Buffer.concat([buf, tmpBuf]);\n        };\n        const appendEncBase64 = (b64) => {\n            const b = decodeBase64(b64);\n            const tmpBuf = Buffer.from(b);\n            buf = Buffer.concat([buf, tmpBuf]);\n        };\n\n        // Actually build the buffer for the QR code\n        appendStr(qrData.prefix, \"ascii\", false);\n        appendByte(qrData.version);\n        appendByte(qrData.mode);\n        appendStr(qrData.transactionId, \"utf-8\");\n        appendEncBase64(qrData.firstKeyB64);\n        appendEncBase64(qrData.secondKeyB64);\n        appendEncBase64(qrData.secretB64);\n\n        return buf;\n    }\n}\n"],"mappings":"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"}